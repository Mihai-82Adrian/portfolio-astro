---
/**
 * Timeline Component
 *
 * Career timeline visualization with company, role, dates, and descriptions.
 * Features eucalyptus green accent colors and responsive vertical layout.
 *
 * @component
 */

import Container from '@components/ui/Container.astro';
import Badge from '@components/ui/Badge.astro';
import Modal from '@components/ui/Modal.astro';

interface TimelineItem {
  id?: string;
  company?: string;
  role?: string;
  title?: string;
  subtitle?: string;
  startDate?: string;
  date?: string;
  endDate?: string; // Optional for current positions
  location?: string;
  description?: string | string[];
  achievements?: string[];
  technologies?: string[];
  tags?: string[];
  icon?: string;
  current?: boolean;
}

interface Props {
  /** Timeline items */
  items?: TimelineItem[];
  /** Section title */
  title?: string;
  /** Section description */
  description?: string;
}

const displayItems = items.length > 0 ? items : defaultItems;
---

<section class="section timeline-section">
  <Container maxWidth="lg" paddingY="lg">
    <!-- Section Header -->
    <div class="section-header">
      <h2 class="section-title">{title}</h2>
      <p class="section-description">{description}</p>
    </div>

    <!-- Timeline -->
    <div class="timeline">
      {displayItems.map((item, index) => (
        <div class="timeline-item">
          {/* Timeline Dot */}
          <div class="timeline-marker">
            <div class:list={['timeline-dot', item.current && 'timeline-dot-current']}>
              {item.current && (
                <span class="timeline-dot-pulse"></span>
              )}
            </div>
            {index < displayItems.length - 1 && (
              <div class="timeline-line"></div>
            )}
          </div>

          {/* Timeline Content */}
          <button
            type="button"
            class="timeline-content"
            data-timeline-item
            data-modal-trigger={`timeline-modal-${item.id || index}`}
            onclick={`window.openModal('timeline-modal-${item.id || index}')`}
            aria-label={`View details for ${item.role} at ${item.company}`}
          >
            <div class="timeline-header">
              {/* Company Logo */}
              {item.icon && (
                <div class="timeline-logo">
                  <img
                    src={item.icon}
                    alt={`${item.company} Logo`}
                    class="company-logo"
                    loading="lazy"
                  />
                </div>
              )}

              <div class="timeline-info">
                <h3 class="timeline-role">{item.role}</h3>
                <p class="timeline-company">{item.company}</p>
                {item.location && (
                  <p class="timeline-location">
                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    {item.location}
                  </p>
                )}
              </div>

              <div class="timeline-meta">
                <time class="timeline-date">
                  {item.startDate} - {item.endDate || 'Present'}
                </time>
              </div>
            </div>

            {/* Achievements */}
            {item.achievements && item.achievements.length > 0 && (
              <ul class="timeline-achievements">
                {item.achievements.map((achievement) => (
                  <li>{achievement}</li>
                ))}
              </ul>
            )}

            {/* Technologies */}
            {item.technologies && item.technologies.length > 0 && (
              <div class="timeline-technologies">
                {item.technologies.map((tech) => (
                  <Badge size="sm">{tech}</Badge>
                ))}
              </div>
            )}
          </button>
        </div>
      ))}
    </div>

    {/* Modals for each timeline item */}
    {displayItems.map((item, index) => (
      <Modal id={`timeline-modal-${item.id || index}`} ariaLabel={`Details for ${item.role} at ${item.company}`} size="lg">
        <div class="modal-timeline-header">
          {item.icon && (
            <div class="modal-company-logo">
              <img
                src={item.icon}
                alt={`${item.company} Logo`}
                class="w-full h-full object-contain"
                loading="lazy"
              />
            </div>
          )}
          <div class="flex-1">
            <h2 id={`timeline-modal-${item.id || index}-title`} class="text-2xl md:text-3xl font-bold text-text-primary-light dark:text-text-primary-dark mb-2">
              {item.role}
            </h2>
            <p class="text-lg font-semibold text-eucalyptus-700 dark:text-eucalyptus-300 mb-1">
              {item.company}
            </p>
            <div class="flex flex-wrap gap-4 text-sm text-text-secondary-light dark:text-text-secondary-dark">
              <time class="font-medium">
                {item.startDate} - {item.endDate || 'Present'}
              </time>
              {item.location && (
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  {item.location}
                </span>
              )}
            </div>
          </div>
        </div>

        {/* Description */}
        {item.description && (
          <div class="mt-6">
            <h3 class="text-lg font-semibold text-text-primary-light dark:text-text-primary-dark mb-3">
              Description
            </h3>
            {Array.isArray(item.description) ? (
              <ul class="list-disc list-inside space-y-2 text-text-secondary-light dark:text-text-secondary-dark">
                {item.description.map((desc) => (
                  <li class="pl-2">{desc}</li>
                ))}
              </ul>
            ) : (
              <p class="text-text-secondary-light dark:text-text-secondary-dark leading-relaxed">
                {item.description}
              </p>
            )}
          </div>
        )}

        {/* Achievements */}
        {item.achievements && item.achievements.length > 0 && (
          <div class="mt-6">
            <h3 class="text-lg font-semibold text-text-primary-light dark:text-text-primary-dark mb-3">
              Key Achievements
            </h3>
            <ul class="list-disc list-inside space-y-2">
              {item.achievements.map((achievement) => (
                <li class="text-text-secondary-light dark:text-text-secondary-dark pl-2">
                  {achievement}
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* Technologies */}
        {item.technologies && item.technologies.length > 0 && (
          <div class="mt-6">
            <h3 class="text-lg font-semibold text-text-primary-light dark:text-text-primary-dark mb-3">
              Technologies & Skills
            </h3>
            <div class="flex flex-wrap gap-2">
              {item.technologies.map((tech) => (
                <Badge size="sm">{tech}</Badge>
              ))}
            </div>
          </div>
        )}
      </Modal>
    ))}
  </Container>
</section>

<style>
  .timeline-section {
    @apply bg-light-bg dark:bg-dark-bg;
  }

  /* Section Header */
  .section-header {
    @apply text-center mb-12 md:mb-16;
  }

  .section-title {
    @apply text-3xl md:text-4xl lg:text-5xl;
    @apply font-bold mb-4;
    @apply text-text-primary-light dark:text-text-primary-dark;
  }

  .section-description {
    @apply text-lg md:text-xl;
    @apply text-text-secondary-light dark:text-text-secondary-dark;
    @apply max-w-3xl mx-auto;
  }

  /* Timeline */
  .timeline {
    @apply relative;
  }

  .timeline-item {
    @apply relative flex gap-6 pb-12 last:pb-0;
  }

  /* Timeline Marker */
  .timeline-marker {
    @apply relative flex flex-col items-center flex-shrink-0;
  }

  .timeline-dot {
    @apply w-4 h-4 rounded-full z-10;
    @apply bg-eucalyptus-600 dark:bg-eucalyptus-400;
    @apply border-4 border-light-bg dark:border-dark-bg;
    @apply transition-all duration-200;
  }

  .timeline-dot-current {
    @apply w-6 h-6;
    @apply relative;
  }

  .timeline-dot-pulse {
    @apply absolute inset-0 rounded-full;
    @apply bg-eucalyptus-600 dark:bg-eucalyptus-400;
    animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  @keyframes pulse-ring {
    0% {
      transform: scale(1);
      opacity: 1;
    }
    100% {
      transform: scale(2);
      opacity: 0;
    }
  }

  .timeline-line {
    @apply w-0.5 h-full flex-grow;
    @apply bg-light-border dark:bg-dark-border;
    @apply mt-2;
  }

  /* Timeline Content */
  .timeline-content {
    @apply flex-grow w-full text-left;
    @apply bg-light-surface dark:bg-dark-surface;
    @apply rounded-lg p-6 md:p-8;
    @apply border border-light-border dark:border-dark-border;
    @apply transition-all duration-200;
    @apply cursor-pointer;
    box-shadow: var(--shadow-card);
  }

  .timeline-content:hover {
    box-shadow: var(--shadow-elevated);
    @apply border-eucalyptus-500 dark:border-eucalyptus-400;
  }

  .timeline-content:focus {
    @apply outline-none ring-2 ring-eucalyptus-500 ring-offset-2;
  }

  .timeline-header {
    @apply flex flex-col md:flex-row md:items-start md:justify-between;
    @apply mb-4;
    @apply gap-4;
  }

  /* Company Logo */
  .timeline-logo {
    @apply w-20 h-20 md:w-24 md:h-24;
    @apply flex-shrink-0;
    @apply bg-white dark:bg-gray-800;
    @apply rounded-lg;
    @apply flex items-center justify-center;
    @apply p-2;
    @apply border border-light-border dark:border-dark-border;
  }

  .company-logo {
    @apply w-full h-full object-contain;
  }

  .timeline-info {
    @apply flex-grow;
  }

  .timeline-role {
    @apply text-lg md:text-xl font-semibold;
    @apply text-text-primary-light dark:text-text-primary-dark;
    @apply mb-1;
  }

  .timeline-company {
    @apply text-base md:text-lg font-medium;
    @apply text-eucalyptus-700 dark:text-eucalyptus-300;
    @apply mb-1;
  }

  .timeline-meta {
    @apply flex-shrink-0;
    @apply text-sm;
  }

  .timeline-date {
    @apply font-medium;
    @apply text-text-secondary-light dark:text-text-secondary-dark;
  }

  .timeline-location {
    @apply text-text-tertiary-light dark:text-text-tertiary-dark;
  }

  .timeline-description {
    @apply text-text-secondary-light dark:text-text-secondary-dark;
    @apply mb-4;
    line-height: 1.6;
  }

  /* Achievements */
  .timeline-achievements {
    @apply list-disc list-inside space-y-2 mb-4;
    @apply text-text-secondary-light dark:text-text-secondary-dark;
  }

  .timeline-achievements li {
    @apply pl-2;
  }

  .timeline-achievements li::marker {
    @apply text-eucalyptus-600 dark:text-eucalyptus-400;
  }

  /* Technologies */
  .timeline-technologies {
    @apply flex flex-wrap gap-2 pt-4;
    @apply border-t border-light-border dark:border-dark-border;
  }

  /* Interactive Animation States */
  .timeline-content {
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
  }

  .timeline-content.timeline-visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* Stagger animation delay for each item */
  .timeline-item:nth-child(1) .timeline-content { transition-delay: 0.1s; }
  .timeline-item:nth-child(2) .timeline-content { transition-delay: 0.2s; }
  .timeline-item:nth-child(3) .timeline-content { transition-delay: 0.3s; }
  .timeline-item:nth-child(4) .timeline-content { transition-delay: 0.4s; }
  .timeline-item:nth-child(5) .timeline-content { transition-delay: 0.5s; }
  .timeline-item:nth-child(n+6) .timeline-content { transition-delay: 0.6s; }

  /* Modal Styles */
  .modal-timeline-header {
    @apply flex flex-col md:flex-row gap-4 md:gap-6 items-start;
    @apply pb-6 mb-6;
    @apply border-b border-light-border dark:border-dark-border;
  }

  .modal-company-logo {
    @apply w-24 h-24 md:w-32 md:h-32;
    @apply flex-shrink-0;
    @apply bg-white dark:bg-gray-800;
    @apply rounded-lg;
    @apply flex items-center justify-center;
    @apply p-3;
    @apply border border-light-border dark:border-dark-border;
  }
</style>

<script>
  // Intersection Observer for scroll animations
  if (typeof window !== 'undefined') {
    const observeTimeline = () => {
      const timelineItems = document.querySelectorAll('[data-timeline-item]');

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add('timeline-visible');
              // Unobserve after animation to improve performance
              observer.unobserve(entry.target);
            }
          });
        },
        {
          threshold: 0.15,
          rootMargin: '0px 0px -50px 0px'
        }
      );

      timelineItems.forEach((item) => {
        observer.observe(item);
      });
    };

    // Run on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', observeTimeline);
    } else {
      observeTimeline();
    }

    // Timeline filtering logic
    const handleTimelineFilter = (event: CustomEvent) => {
      const { companies, technologies, yearStart, yearEnd } = event.detail;

      const timelineItems = document.querySelectorAll('.timeline-item');

      timelineItems.forEach((item) => {
        const button = item.querySelector('button[data-timeline-item]');
        if (!button) return;

        // Extract item data from button attributes or text content
        const companyElement = item.querySelector('.timeline-company');
        const techElements = item.querySelectorAll('.timeline-technologies [class*="badge"]');
        const dateElement = item.querySelector('.timeline-date');

        const company = companyElement?.textContent?.trim() || '';
        const techs = Array.from(techElements).map(el => el.textContent?.trim() || '');
        const dateText = dateElement?.textContent?.trim() || '';

        // Parse year from date (format: "MM/YYYY - MM/YYYY" or "MM/YYYY - Present")
        const yearMatch = dateText.match(/\d{4}/);
        const itemStartYear = yearMatch ? parseInt(yearMatch[0]) : 0;

        const allYearMatches = dateText.match(/\d{4}/g) || [];
        const itemEndYear = allYearMatches.length > 1
          ? parseInt(allYearMatches[allYearMatches.length - 1])
          : (dateText.includes('Present') || dateText.includes('Heute') ? new Date().getFullYear() : itemStartYear);

        // Apply filters
        let shouldShow = true;

        // Company filter
        if (companies.length > 0 && !companies.includes(company)) {
          shouldShow = false;
        }

        // Technology filter (show if ANY technology matches)
        if (technologies.length > 0) {
          const hasMatchingTech = technologies.some(tech => techs.includes(tech));
          if (!hasMatchingTech) {
            shouldShow = false;
          }
        }

        // Year range filter
        const filterStartYear = yearStart ? parseInt(yearStart) : 0;
        const filterEndYear = yearEnd ? parseInt(yearEnd) : 9999;

        if (itemEndYear < filterStartYear || itemStartYear > filterEndYear) {
          shouldShow = false;
        }

        // Show/hide item
        const itemElement = item as HTMLElement;
        if (shouldShow) {
          itemElement.style.display = '';
          itemElement.removeAttribute('aria-hidden');
        } else {
          itemElement.style.display = 'none';
          itemElement.setAttribute('aria-hidden', 'true');
        }
      });
    };

    // Listen for filter events
    document.addEventListener('timeline:filter', handleTimelineFilter as EventListener);
  }
</script>

