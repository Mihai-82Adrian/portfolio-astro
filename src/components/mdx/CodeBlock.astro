---
/**
 * CodeBlock Component
 *
 * Syntax-highlighted code block with copy-to-clipboard functionality,
 * language label, and optional line numbers.
 *
 * @component
 * @example
 * <CodeBlock lang="rust" title="main.rs" showLineNumbers>
 *   fn main() { println!("Hello!"); }
 * </CodeBlock>
 */

interface Props {
  /** Programming language for syntax highlighting */
  lang?: string;
  /** File name or title */
  title?: string;
  /** Show line numbers */
  showLineNumbers?: boolean;
  /** Code content (use slot instead for MDX) */
  code?: string;
  /** Additional CSS classes */
  class?: string;
}

const {
  lang = 'plaintext',
  title,
  showLineNumbers = false,
  code,
  class: className = '',
} = Astro.props;

const languageLabels: Record<string, string> = {
  js: 'JavaScript',
  ts: 'TypeScript',
  jsx: 'JSX',
  tsx: 'TSX',
  rust: 'Rust',
  rs: 'Rust',
  julia: 'Julia',
  jl: 'Julia',
  python: 'Python',
  py: 'Python',
  bash: 'Bash',
  sh: 'Shell',
  html: 'HTML',
  css: 'CSS',
  json: 'JSON',
  yaml: 'YAML',
  toml: 'TOML',
  sql: 'SQL',
  go: 'Go',
  java: 'Java',
  cpp: 'C++',
  c: 'C',
};

const displayLang = languageLabels[lang] || lang.toUpperCase();
---

<div class:list={['code-block-wrapper', className]}>
  <!-- Header -->
  <div class="code-block-header">
    <div class="code-block-info">
      {title && <span class="code-block-title">{title}</span>}
      <span class="code-block-lang">{displayLang}</span>
    </div>
    <button
      type="button"
      class="code-block-copy-button"
      data-code-copy
      aria-label="Copy code to clipboard"
      title="Copy code"
    >
      <svg
        class="code-block-copy-icon"
        data-copy-icon
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
        />
      </svg>
      <svg
        class="code-block-check-icon hidden"
        data-check-icon
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M5 13l4 4L19 7"
        />
      </svg>
      <span class="code-block-copy-text" data-copy-text>Copy</span>
    </button>
  </div>

  <!-- Code Content -->
  <div class="code-block-content">
    <pre
      class:list={[
        'code-block-pre',
        `language-${lang}`,
        showLineNumbers && 'line-numbers',
      ]}
    ><code class={`language-${lang}`}>{code || ''}<slot /></code></pre>
  </div>
</div>

<script>
  // Copy to clipboard functionality
  document.querySelectorAll('[data-code-copy]').forEach((button) => {
    button.addEventListener('click', async () => {
      const codeBlock = button.closest('.code-block-wrapper');
      const code = codeBlock?.querySelector('code')?.textContent || '';

      try {
        await navigator.clipboard.writeText(code);

        // Update button UI
        const copyIcon = button.querySelector('[data-copy-icon]');
        const checkIcon = button.querySelector('[data-check-icon]');
        const copyText = button.querySelector('[data-copy-text]');

        if (copyIcon && checkIcon && copyText) {
          copyIcon.classList.add('hidden');
          checkIcon.classList.remove('hidden');
          copyText.textContent = 'Copied!';

          // Reset after 2 seconds
          setTimeout(() => {
            copyIcon.classList.remove('hidden');
            checkIcon.classList.add('hidden');
            copyText.textContent = 'Copy';
          }, 2000);
        }
      } catch (err) {
        console.error('Failed to copy code:', err);
      }
    });
  });
</script>

<style>
  .code-block-wrapper {
    @apply rounded-lg overflow-hidden my-6;
    @apply border border-light-border dark:border-dark-border;
  }

  /* Header */
  .code-block-header {
    @apply flex items-center justify-between px-4 py-2;
    @apply bg-light-surface dark:bg-dark-surface;
    @apply border-b border-light-border dark:border-dark-border;
  }

  .code-block-info {
    @apply flex items-center gap-3;
  }

  .code-block-title {
    @apply text-sm font-medium;
    @apply text-text-primary-light dark:text-text-primary-dark;
  }

  .code-block-lang {
    @apply text-xs font-medium px-2 py-1 rounded;
    @apply bg-eucalyptus-100 text-eucalyptus-800;
    @apply dark:bg-eucalyptus-900 dark:text-eucalyptus-200;
  }

  /* Copy Button */
  .code-block-copy-button {
    @apply flex items-center gap-2 px-3 py-1.5 rounded;
    @apply text-sm font-medium;
    @apply text-text-secondary-light dark:text-text-secondary-dark;
    @apply hover:text-eucalyptus-700 dark:hover:text-eucalyptus-300;
    @apply hover:bg-eucalyptus-50 dark:hover:bg-dark-elevated;
    @apply transition-all duration-150;
  }

  .code-block-copy-icon,
  .code-block-check-icon {
    @apply w-4 h-4;
  }

  .code-block-copy-text {
    @apply hidden sm:inline;
  }

  /* Code Content */
  .code-block-content {
    @apply relative;
  }

  .code-block-pre {
    @apply m-0 p-4 overflow-x-auto;
    @apply bg-dark-surface;
    @apply text-text-primary-dark;
    @apply font-mono text-sm;
    line-height: 1.6;
  }

  .code-block-pre code {
    @apply bg-transparent p-0;
    color: inherit;
  }

  /* Line numbers (if enabled) */
  .line-numbers {
    counter-reset: line;
  }

  .line-numbers code {
    display: block;
  }

  .line-numbers code > * {
    display: block;
    counter-increment: line;
  }

  .line-numbers code > *::before {
    content: counter(line);
    display: inline-block;
    width: 2.5rem;
    margin-right: 1rem;
    text-align: right;
    @apply text-text-tertiary-dark;
    user-select: none;
  }

  /* Scrollbar styling */
  .code-block-pre::-webkit-scrollbar {
    height: 8px;
  }

  .code-block-pre::-webkit-scrollbar-track {
    @apply bg-dark-elevated;
  }

  .code-block-pre::-webkit-scrollbar-thumb {
    @apply bg-eucalyptus-700;
    border-radius: 4px;
  }

  .code-block-pre::-webkit-scrollbar-thumb:hover {
    @apply bg-eucalyptus-600;
  }
</style>
