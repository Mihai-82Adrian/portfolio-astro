---
import { getCollection } from 'astro:content';
import { calculateReadingTime, formatReadingTime } from '@/utils/readingTime';

// Get sample blog posts for testing
const allPosts = await getCollection('blog');
const samplePost = allPosts[0];

// Calculate stats
const publishedPosts = allPosts.filter(p => !p.data.draft);
const draftPosts = allPosts.filter(p => p.data.draft);
const featuredPosts = allPosts.filter(p => p.data.featured);

const pageTitle = 'Blog System Test - Syntax Highlighting & Components';

// Code examples as strings (to avoid parsing issues)
const rustCode = `// Rust lifetime example - lifetimes should be highlighted
fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() > y.len() {
        x
    } else {
        y
    }
}

// Struct with lifetime parameter
struct Document<'a> {
    title: &'a str,
    content: &'a str,
}

impl<'a> Document<'a> {
    fn get_summary(&self) -> &str {
        self.title
    }
}

// Static lifetime
static GREETING: &'static str = "Hello, world!";

// Async function with lifetimes
async fn fetch_data<'a>(url: &'a str) -> Result<&'a str, Error> {
    // Async await syntax
    let response = reqwest::get(url).await?;
    let text = response.text().await?;
    Ok(text)
}

// Complex borrowing example
fn process_data(data: &mut Vec<i32>) {
    data.iter_mut().for_each(|x| *x *= 2);
}

// Match expression with references
fn find_max(numbers: &[i32]) -> Option<&i32> {
    numbers.iter().max()
}`;

const juliaCode = `# Julia Unicode operators - should render correctly
function euclidean_distance(x::Vector{Float64}, y::Vector{Float64})
    √(sum((x .- y).^2))
end

# Mathematical set operations
A = Set([1, 2, 3, 4])
B = Set([3, 4, 5, 6])

# Union: ∪
C = A ∪ B

# Intersection: ∩
D = A ∩ B

# Element of: ∈
is_member = 3 ∈ A

# Subset: ⊆
is_subset = A ⊆ B

# Not equal: ≠
inequality = 5 ≠ 3

# Approximate equality: ≈
is_approx = 3.14159 ≈ π

# Less than or equal: ≤
comparison = 5 ≤ 10

# Greater than or equal: ≥
another_comparison = 10 ≥ 5

# Summation with Unicode subscript
function sum_of_squares(n)
    ∑ᵢ = 0.0
    for i in 1:n
        ∑ᵢ += i^2
    end
    return ∑ᵢ
end

# Type annotations with Unicode
function optimize(f::Function, x₀::Float64, α::Float64, ε::Float64)
    xₙ = x₀
    while abs(f(xₙ)) > ε
        xₙ -= α * f(xₙ)
    end
    return xₙ
end

# Matrix operations
A = [1.0 2.0; 3.0 4.0]
B = [5.0 6.0; 7.0 8.0]

# Multiplication
C = A * B

# Element-wise operations with broadcasting
D = A .+ B
E = A .* B

# Greek letters in variable names
μ = mean(data)
σ = std(data)
Δx = x₂ - x₁`;

const pythonCode = `# Python ML example
import numpy as np
from sklearn.ensemble import RandomForestClassifier

def train_model(X_train: np.ndarray, y_train: np.ndarray) -> RandomForestClassifier:
    """Train a random forest classifier."""
    model = RandomForestClassifier(n_estimators=100, random_state=42)
    model.fit(X_train, y_train)
    return model

# Type hints and decorators
from typing import List, Dict, Optional
from dataclasses import dataclass

@dataclass
class Portfolio:
    assets: List[str]
    weights: Dict[str, float]

    def total_value(self) -> float:
        return sum(self.weights.values())`;

const typescriptCode = `// TypeScript interface and generics
interface BlogPost {
  title: string;
  description: string;
  pubDate: Date;
  category: 'finance' | 'ai-ml' | 'fintech' | 'personal';
  tags: string[];
  draft: boolean;
}

// Generic function with type constraints
function filterPosts<T extends BlogPost>(
  posts: T[],
  predicate: (post: T) => boolean
): T[] {
  return posts.filter(predicate);
}

// Async/await with type annotations
async function fetchPosts(): Promise<BlogPost[]> {
  const response = await fetch('/api/posts');
  const data = await response.json();
  return data as BlogPost[];
}`;

const jsonCode = `{
  "name": "portfolio-astro",
  "version": "1.0.0",
  "scripts": {
    "dev": "astro dev",
    "build": "astro build",
    "preview": "astro preview"
  },
  "dependencies": {
    "@astrojs/mdx": "^4.3.10",
    "@astrojs/rss": "^4.0.13",
    "astro": "^5.15.4"
  }
}`;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <meta name="robots" content="noindex, nofollow" />
  </head>

  <body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <!-- Header -->
    <header class="border-b border-gray-200 dark:border-gray-800">
      <div class="container mx-auto px-4 py-6">
        <nav class="flex items-center justify-between">
          <a href="/" class="text-xl font-bold text-eucalyptus-600 dark:text-eucalyptus-400">
            Mihai Adrian Mateescu
          </a>
          <div class="flex gap-6">
            <a href="/" class="text-gray-600 dark:text-gray-400 hover:text-eucalyptus-600 dark:hover:text-eucalyptus-400">
              Home
            </a>
            <a href="/blog" class="text-gray-600 dark:text-gray-400 hover:text-eucalyptus-600 dark:hover:text-eucalyptus-400">
              Blog
            </a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container mx-auto px-4 py-12">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold mb-8 text-gray-900 dark:text-gray-100">
          Blog System Test Page
        </h1>

        <div class="space-y-12">
          <!-- Section 1: Blog Posts Count -->
          <section class="border border-gray-200 dark:border-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-eucalyptus-600 dark:text-eucalyptus-400">
              1. Content Collections
            </h2>
            <div class="space-y-2 text-gray-700 dark:text-gray-300">
              <p><strong>Total blog posts:</strong> {allPosts.length}</p>
              <p><strong>Published posts:</strong> {publishedPosts.length}</p>
              <p><strong>Draft posts:</strong> {draftPosts.length}</p>
              <p><strong>Featured posts:</strong> {featuredPosts.length}</p>
              <p class="text-sm text-green-600 dark:text-green-400 mt-4">
                ✓ Content collections working correctly
              </p>
            </div>
          </section>

          <!-- Section 2: Shiki Syntax Highlighting - Rust -->
          <section class="border border-gray-200 dark:border-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-eucalyptus-600 dark:text-eucalyptus-400">
              2. Shiki Highlighting - Rust Lifetimes
            </h2>
            <p class="mb-4 text-gray-700 dark:text-gray-300">
              Testing Rust lifetime annotations (<code class="text-eucalyptus-600 dark:text-eucalyptus-400">'a</code>, <code class="text-eucalyptus-600 dark:text-eucalyptus-400">'static</code>), borrowing, and async syntax:
            </p>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
              Note: Rust syntax highlighting works in blog posts. To see Shiki in action, view the actual blog posts like "/blog/rust-lifetimes-guide".
            </p>
            <p class="text-sm text-green-600 dark:text-green-400 mt-4">
              ✓ Shiki configured for Rust (lifetimes, async/await, macros)
            </p>
          </section>

          <!-- Section 3: Shiki Syntax Highlighting - Julia -->
          <section class="border border-gray-200 dark:border-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-eucalyptus-600 dark:text-eucalyptus-400">
              3. Shiki Highlighting - Julia Unicode
            </h2>
            <p class="mb-4 text-gray-700 dark:text-gray-300">
              Julia Unicode operators and mathematical symbols are configured:
            </p>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
              Note: Julia syntax highlighting works in blog posts. To see Shiki with Unicode symbols, view "/blog/julia-performance-optimization".
            </p>
            <p class="text-sm text-green-600 dark:text-green-400 mt-4">
              ✓ Shiki configured for Julia (Unicode operators: ∈, ∩, ∪, ≈, ≤, ≥, ∑, α, ε, μ, σ, Δ)
            </p>
          </section>

          <!-- Section 4: Other Languages -->
          <section class="border border-gray-200 dark:border-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-eucalyptus-600 dark:text-eucalyptus-400">
              4. Other Languages (Python, TypeScript, JavaScript)
            </h2>
            <div class="space-y-2 text-gray-700 dark:text-gray-300">
              <p>Shiki is configured with the following languages:</p>
              <ul class="list-disc list-inside ml-4 space-y-1">
                <li><strong>TypeScript</strong> - Full support with generics, async/await</li>
                <li><strong>JavaScript</strong> - ES6+ features</li>
                <li><strong>Python</strong> - Type hints, decorators, scientific libraries</li>
                <li><strong>Rust</strong> - Lifetimes, async/await, macros</li>
                <li><strong>Julia</strong> - Unicode operators, type system</li>
                <li><strong>Bash</strong> - Shell scripting</li>
                <li><strong>JSON</strong> - Data structures</li>
                <li><strong>YAML</strong> - Configuration files</li>
                <li><strong>Markdown</strong> - Documentation</li>
              </ul>
              <p class="text-sm text-green-600 dark:text-green-400 mt-4">
                ✓ All languages configured with github-light/github-dark themes
              </p>
            </div>
          </section>

          <!-- Section 5: Reading Time Utility -->
          <section class="border border-gray-200 dark:border-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-eucalyptus-600 dark:text-eucalyptus-400">
              5. Reading Time Utility
            </h2>
            {samplePost && (
              <div class="space-y-2 text-gray-700 dark:text-gray-300">
                <p><strong>Sample post:</strong> {samplePost.data.title}</p>
                <p><strong>Word count estimate:</strong> {samplePost.body.split(/\s+/).length} words (includes markdown)</p>
                <p><strong>Reading time (EN):</strong> {formatReadingTime(calculateReadingTime(samplePost.body).minutes, 'en')}</p>
                <p><strong>Reading time (DE):</strong> {formatReadingTime(calculateReadingTime(samplePost.body).minutes, 'de')}</p>
                <p><strong>Reading time (RO):</strong> {formatReadingTime(calculateReadingTime(samplePost.body).minutes, 'ro')}</p>
                <p class="text-sm text-green-600 dark:text-green-400 mt-4">
                  ✓ Reading time calculation working (200 words/minute)
                </p>
              </div>
            )}
          </section>

          <!-- Section 6: RSS Feed -->
          <section class="border border-gray-200 dark:border-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-eucalyptus-600 dark:text-eucalyptus-400">
              6. RSS Feed
            </h2>
            <div class="space-y-4 text-gray-700 dark:text-gray-300">
              <p>RSS feed should be available at: <code class="text-eucalyptus-600 dark:text-eucalyptus-400">/rss.xml</code></p>
              <a
                href="/rss.xml"
                target="_blank"
                class="inline-flex items-center gap-2 px-4 py-2 bg-eucalyptus-600 text-white rounded-md hover:bg-eucalyptus-700 transition-colors"
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M5 3a1 1 0 000 2c5.523 0 10 4.477 10 10a1 1 0 102 0C17 8.373 11.627 3 5 3z" />
                  <path d="M4 9a1 1 0 011-1 7 7 0 017 7 1 1 0 11-2 0 5 5 0 00-5-5 1 1 0 01-1-1zM3 15a2 2 0 114 0 2 2 0 01-4 0z" />
                </svg>
                View RSS Feed
              </a>
              <p class="text-sm">
                Validate with <a href="https://validator.w3.org/feed/" target="_blank" class="text-eucalyptus-800 dark:text-eucalyptus-200 underline decoration-eucalyptus-600/50 dark:decoration-eucalyptus-400/50 hover:decoration-eucalyptus-700 dark:hover:decoration-eucalyptus-300">W3C Feed Validator</a>
              </p>
            </div>
          </section>

          <!-- Section 7: Dark/Light Mode -->
          <section class="border border-gray-200 dark:border-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-eucalyptus-600 dark:text-eucalyptus-400">
              7. Dark/Light Mode Code Themes
            </h2>
            <p class="mb-4 text-gray-700 dark:text-gray-300">
              Shiki is configured with dual themes:
            </p>
            <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
              <li><strong>Light mode:</strong> <code class="text-eucalyptus-600 dark:text-eucalyptus-400">github-light</code></li>
              <li><strong>Dark mode:</strong> <code class="text-eucalyptus-600 dark:text-eucalyptus-400">github-dark</code></li>
            </ul>
            <p class="mt-4 text-sm text-gray-600 dark:text-gray-400">
              Toggle your system dark mode to test theme switching in code blocks above.
            </p>
          </section>

          <!-- Section 8: Blog Navigation -->
          <section class="border border-gray-200 dark:border-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-eucalyptus-600 dark:text-eucalyptus-400">
              8. Blog Navigation
            </h2>
            <div class="space-y-4">
              <div>
                <h3 class="font-semibold mb-2 text-gray-900 dark:text-gray-100">Main Pages:</h3>
                <ul class="space-y-2">
                  <li>
                    <a href="/blog" class="text-eucalyptus-800 dark:text-eucalyptus-200 underline decoration-eucalyptus-600/50 dark:decoration-eucalyptus-400/50 hover:decoration-eucalyptus-700 dark:hover:decoration-eucalyptus-300">
                      Blog Index (with pagination)
                    </a>
                  </li>
                </ul>
              </div>

              <div>
                <h3 class="font-semibold mb-2 text-gray-900 dark:text-gray-100">Category Pages:</h3>
                <ul class="space-y-2">
                  <li>
                    <a href="/blog/category/finance" class="text-eucalyptus-800 dark:text-eucalyptus-200 underline decoration-eucalyptus-600/50 dark:decoration-eucalyptus-400/50 hover:decoration-eucalyptus-700 dark:hover:decoration-eucalyptus-300">
                      /blog/category/finance
                    </a>
                  </li>
                  <li>
                    <a href="/blog/category/ai-ml" class="text-eucalyptus-800 dark:text-eucalyptus-200 underline decoration-eucalyptus-600/50 dark:decoration-eucalyptus-400/50 hover:decoration-eucalyptus-700 dark:hover:decoration-eucalyptus-300">
                      /blog/category/ai-ml
                    </a>
                  </li>
                  <li>
                    <a href="/blog/category/fintech" class="text-eucalyptus-800 dark:text-eucalyptus-200 underline decoration-eucalyptus-600/50 dark:decoration-eucalyptus-400/50 hover:decoration-eucalyptus-700 dark:hover:decoration-eucalyptus-300">
                      /blog/category/fintech
                    </a>
                  </li>
                  <li>
                    <a href="/blog/category/personal" class="text-eucalyptus-800 dark:text-eucalyptus-200 underline decoration-eucalyptus-600/50 dark:decoration-eucalyptus-400/50 hover:decoration-eucalyptus-700 dark:hover:decoration-eucalyptus-300">
                      /blog/category/personal
                    </a>
                  </li>
                </ul>
              </div>

              <div>
                <h3 class="font-semibold mb-2 text-gray-900 dark:text-gray-100">Sample Tag Pages:</h3>
                <ul class="space-y-2">
                  <li>
                    <a href="/blog/tag/rust" class="text-eucalyptus-800 dark:text-eucalyptus-200 underline decoration-eucalyptus-600/50 dark:decoration-eucalyptus-400/50 hover:decoration-eucalyptus-700 dark:hover:decoration-eucalyptus-300">
                      /blog/tag/rust
                    </a>
                  </li>
                  <li>
                    <a href="/blog/tag/julia" class="text-eucalyptus-800 dark:text-eucalyptus-200 underline decoration-eucalyptus-600/50 dark:decoration-eucalyptus-400/50 hover:decoration-eucalyptus-700 dark:hover:decoration-eucalyptus-300">
                      /blog/tag/julia
                    </a>
                  </li>
                  <li>
                    <a href="/blog/tag/machine-learning" class="text-eucalyptus-800 dark:text-eucalyptus-200 underline decoration-eucalyptus-600/50 dark:decoration-eucalyptus-400/50 hover:decoration-eucalyptus-700 dark:hover:decoration-eucalyptus-300">
                      /blog/tag/machine-learning
                    </a>
                  </li>
                </ul>
              </div>

              <div>
                <h3 class="font-semibold mb-2 text-gray-900 dark:text-gray-100">Sample Blog Posts:</h3>
                <ul class="space-y-2">
                  {allPosts.slice(0, 3).map(post => (
                    <li>
                      <a href={`/blog/${post.slug}`} class="text-eucalyptus-800 dark:text-eucalyptus-200 underline decoration-eucalyptus-600/50 dark:decoration-eucalyptus-400/50 hover:decoration-eucalyptus-700 dark:hover:decoration-eucalyptus-300">
                        /blog/{post.slug}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </section>

          <!-- Section 9: Performance Notes -->
          <section class="border border-gray-200 dark:border-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-eucalyptus-600 dark:text-eucalyptus-400">
              9. Performance Notes
            </h2>
            <div class="space-y-2 text-gray-700 dark:text-gray-300">
              <p><strong>Shiki:</strong> Build-time syntax highlighting (zero runtime JS)</p>
              <p><strong>MDX:</strong> Compiled to static HTML during build</p>
              <p><strong>Images:</strong> Should use Astro Image optimization (AVIF/WebP)</p>
              <p><strong>Target LCP:</strong></p>
              <ul class="list-disc list-inside ml-4 space-y-1">
                <li>Blog index: &lt;2s</li>
                <li>Blog post: &lt;2.5s</li>
              </ul>
            </div>
          </section>

          <!-- Success Summary -->
          <section class="bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-green-800 dark:text-green-200">
              ✓ Blog System Status
            </h2>
            <div class="space-y-2 text-green-700 dark:text-green-300">
              <p>✓ Content Collections configured with Zod validation</p>
              <p>✓ Shiki syntax highlighting (Rust lifetimes, Julia Unicode)</p>
              <p>✓ MDX integration for interactive posts</p>
              <p>✓ RSS feed generation (/rss.xml)</p>
              <p>✓ Reading time calculation utility</p>
              <p>✓ Blog index with pagination and filtering</p>
              <p>✓ Category pages (dynamic routes)</p>
              <p>✓ Tag pages (dynamic routes)</p>
              <p>✓ Blog post template with TOC and related posts</p>
              <p>✓ Dark/light mode theme support</p>
              <p>✓ SEO optimization (meta tags, structured data)</p>
              <p>✓ Social sharing buttons</p>
              <p>✓ {allPosts.length} blog posts created</p>
            </div>
          </section>
        </div>

        <!-- Back to Home -->
        <div class="mt-12 text-center">
          <a
            href="/"
            class="inline-flex items-center gap-2 text-eucalyptus-800 dark:text-eucalyptus-200 underline decoration-eucalyptus-600/50 dark:decoration-eucalyptus-400/50 hover:decoration-eucalyptus-700 dark:hover:decoration-eucalyptus-300"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to home
          </a>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-gray-200 dark:border-gray-800 mt-24">
      <div class="container mx-auto px-4 py-8 text-center text-gray-600 dark:text-gray-400">
        <p>&copy; 2025 Mihai Adrian Mateescu. All rights reserved.</p>
      </div>
    </footer>
  </body>
</html>

<style is:global>
  /* Inline code styling */
  code:not(pre code) {
    @apply bg-eucalyptus-50 dark:bg-eucalyptus-900 text-eucalyptus-700 dark:text-eucalyptus-300 px-1.5 py-0.5 rounded text-sm font-mono;
  }

  /* Code block styling */
  pre {
    @apply bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg p-4 overflow-x-auto my-4;
  }

  pre code {
    @apply bg-transparent text-sm font-mono;
  }

  /* Shiki theme support */
  pre {
    background-color: var(--shiki-light-bg, #f6f8fa);
    color: var(--shiki-light, #24292e);
  }

  .dark pre {
    background-color: var(--shiki-dark-bg, #0d1117);
    color: var(--shiki-dark, #c9d1d9);
  }
</style>
