---
import { getCollection, type CollectionEntry } from 'astro:content';
import PostList from '@/components/blog/PostList.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);

  // Get unique tags
  const allTags = new Set<string>();
  allPosts.forEach(post => {
    post.data.tags.forEach(tag => allTags.add(tag));
  });

  // Generate paths for each tag
  return Array.from(allTags).map(tag => ({
    params: { tag },
    props: {
      tag,
      posts: allPosts
        .filter(post => post.data.tags.includes(tag))
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

interface Props {
  tag: string;
  posts: CollectionEntry<'blog'>[];
}

const { tag, posts } = Astro.props;

// Format tag for display
const tagDisplay = tag
  .split('-')
  .map(word => word.charAt(0).toUpperCase() + word.slice(1))
  .join(' ');

const pageTitle = `#${tagDisplay} - Blog - Mihai Adrian Mateescu`;
const pageDescription = `Articles tagged with #${tagDisplay}. ${posts.length} ${posts.length === 1 ? 'article' : 'articles'} found.`;

// Get related tags (tags that appear in same posts as current tag)
const relatedTagsMap = new Map<string, number>();
posts.forEach(post => {
  post.data.tags.forEach(t => {
    if (t !== tag) {
      relatedTagsMap.set(t, (relatedTagsMap.get(t) || 0) + 1);
    }
  });
});

const relatedTags = Array.from(relatedTagsMap.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10)
  .map(([tagName]) => tagName);
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />

    <!-- Open Graph / Social Media -->
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />

    <!-- Canonical URL -->
    <link rel="canonical" href={Astro.url} />

    <!-- RSS Feed -->
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Blog RSS Feed"
      href="/rss.xml"
    />
  </head>

  <body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <!-- Header -->
    <header class="border-b border-gray-200 dark:border-gray-800">
      <div class="container mx-auto px-4 py-6">
        <nav class="flex items-center justify-between">
          <a href="/" class="text-xl font-bold text-eucalyptus-600 dark:text-eucalyptus-400">
            Mihai Adrian Mateescu
          </a>
          <div class="flex gap-6">
            <a href="/" class="text-gray-600 dark:text-gray-400 hover:text-eucalyptus-600 dark:hover:text-eucalyptus-400">
              Home
            </a>
            <a href="/blog" class="text-eucalyptus-600 dark:text-eucalyptus-400 font-semibold">
              Blog
            </a>
            <a href="/projects" class="text-gray-600 dark:text-gray-400 hover:text-eucalyptus-600 dark:hover:text-eucalyptus-400">
              Projects
            </a>
          </div>
        </nav>
      </div>
    </header>

    <main class="container mx-auto px-4 py-12">
      <!-- Breadcrumb -->
      <nav class="text-sm text-gray-600 dark:text-gray-400 mb-8">
        <a href="/" class="hover:text-eucalyptus-600 dark:hover:text-eucalyptus-400">Home</a>
        <span class="mx-2">/</span>
        <a href="/blog" class="hover:text-eucalyptus-600 dark:hover:text-eucalyptus-400">Blog</a>
        <span class="mx-2">/</span>
        <span class="text-gray-400 dark:text-gray-500">#{tagDisplay}</span>
      </nav>

      <!-- Page Header -->
      <div class="mb-12">
        <div class="inline-block px-4 py-2 bg-eucalyptus-100 dark:bg-eucalyptus-900 text-eucalyptus-700 dark:text-eucalyptus-300 rounded-md mb-4">
          Tag
        </div>
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-gray-100 mb-4">
          #{tagDisplay}
        </h1>
        <p class="text-xl text-gray-600 dark:text-gray-400 max-w-3xl">
          {posts.length} {posts.length === 1 ? 'article' : 'articles'} tagged with
          <span class="text-eucalyptus-600 dark:text-eucalyptus-400 font-semibold">
            #{tagDisplay}
          </span>
        </p>
      </div>

      <!-- Posts -->
      {posts.length > 0 ? (
        <PostList posts={posts} />
      ) : (
        <div class="text-center py-16">
          <p class="text-xl text-gray-600 dark:text-gray-400">
            No articles with this tag yet. Check back soon!
          </p>
          <a
            href="/blog"
            class="inline-block mt-6 px-6 py-3 bg-eucalyptus-600 text-white rounded-md font-semibold hover:bg-eucalyptus-700 transition-colors"
          >
            View All Posts
          </a>
        </div>
      )}

      <!-- Related Tags -->
      {relatedTags.length > 0 && (
        <div class="mt-16 p-6 bg-gray-50 dark:bg-gray-800 rounded-lg">
          <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">
            Related Tags
          </h2>
          <div class="flex flex-wrap gap-2">
            {relatedTags.map(relatedTag => (
              <a
                href={`/blog/tag/${relatedTag}`}
                class="px-3 py-1 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-md hover:bg-eucalyptus-100 dark:hover:bg-eucalyptus-900 transition-colors border border-gray-200 dark:border-gray-600"
              >
                #{relatedTag}
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Back to Blog -->
      <div class="mt-12 text-center">
        <a
          href="/blog"
          class="inline-flex items-center gap-2 text-eucalyptus-800 dark:text-eucalyptus-200 underline decoration-eucalyptus-600/50 dark:decoration-eucalyptus-400/50 hover:decoration-eucalyptus-700 dark:hover:decoration-eucalyptus-300"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to all posts
        </a>
      </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-gray-200 dark:border-gray-800 mt-24">
      <div class="container mx-auto px-4 py-8 text-center text-gray-600 dark:text-gray-400">
        <p>&copy; 2025 Mihai Adrian Mateescu. All rights reserved.</p>
      </div>
    </footer>
  </body>
</html>
