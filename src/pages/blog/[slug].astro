---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Container from '@/components/ui/Container.astro';
import Card from '@/components/ui/Card.astro';
import Badge from '@/components/ui/Badge.astro';
import PostMeta from '@/components/blog/PostMeta.astro';
import TableOfContents from '@/components/blog/TableOfContents.astro';
import LearningDisclaimer from '@/components/blog/LearningDisclaimer.astro';
import ShareButtons from '@/components/blog/ShareButtons.astro';
import Newsletter from '@/components/blog/Newsletter.astro';
import Comments from '@/components/blog/Comments.astro';
import { calculateReadingTime } from '@/utils/readingTime';
import { generateBlogPostingSchema } from '@/utils/structuredData';
import { getRelatedPosts } from '@/lib/utils/relatedPosts';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { title, description, pubDate, updatedDate, category, tags, author } = post.data;
const { Content, headings } = await post.render();

// Calculate reading time
const readingTimeData = calculateReadingTime(post.body);
const readingTime = readingTimeData.minutes;

// Get all posts for related posts calculation
const allPosts = await getCollection('blog', ({ data }) => !data.draft);

// Get related posts using similarity algorithm (category + tags + recency)
const relatedPosts = getRelatedPosts(post, allPosts, 3);

const pageTitle = `${title} - Mihai Adrian Mateescu`;

// Generate BlogPosting structured data
const blogPostingSchema = generateBlogPostingSchema(post, Astro.url.toString());
---

<BaseLayout title={pageTitle} description={description} lang="en" structuredData={[blogPostingSchema]}>
  <Container>
    <!-- Breadcrumb -->
    <nav class="text-sm text-text-secondary-light dark:text-text-secondary-dark mb-8 pt-8">
      <a href="/" class="hover:text-eucalyptus-600 dark:hover:text-eucalyptus-400">Home</a>
      <span class="mx-2">/</span>
      <a href="/blog" class="hover:text-eucalyptus-600 dark:hover:text-eucalyptus-400">Blog</a>
      <span class="mx-2">/</span>
      <a href={`/blog/category/${category}`} class="hover:text-eucalyptus-600 dark:hover:text-eucalyptus-400">
        {category}
      </a>
      <span class="mx-2">/</span>
      <span class="text-text-tertiary-light dark:text-text-tertiary-dark">{title}</span>
    </nav>

    <div class="grid lg:grid-cols-[1fr_250px] gap-12">
      <!-- Main Content -->
      <article>
        <!-- Post Title -->
        <header class="mb-8">
          <h1 class="text-4xl md:text-5xl font-bold text-text-primary-light dark:text-text-primary-dark mb-4">
            {title}
          </h1>
          {description && (
            <p class="text-xl text-text-secondary-light dark:text-text-secondary-dark">
              {description}
            </p>
          )}
        </header>

        <!-- Hero Image -->
        {post.data.heroImage && (
          <div class="mb-8 -mx-4 sm:mx-0">
            <img
              src={post.data.heroImage}
              alt={title}
              class="w-full h-auto rounded-lg shadow-lg object-cover"
              loading="eager"
              decoding="async"
              width="1200"
              height="630"
            />
          </div>
        )}

        <!-- Post Meta -->
        <PostMeta
          author={author}
          pubDate={pubDate}
          readingTime={readingTime}
          category={category}
        />

        <!-- Learning Disclaimer for technical posts -->
        {(category === 'ai-ml' || tags.includes('rust') || tags.includes('julia') || tags.includes('machine-learning') || tags.includes('career')) && (
          <LearningDisclaimer />
        )}

        <!-- Post Content with Prose Styling -->
        <div class="prose dark:prose-invert max-w-none mt-8">
          <Content />
        </div>

        <!-- Post Footer: Tags and Share -->
        <footer class="mt-12 pt-8 border-t border-border-light dark:border-border-dark">
          <!-- Tags -->
          <div class="mb-6">
            <h3 class="text-sm font-semibold text-text-primary-light dark:text-text-primary-dark mb-3">
              Tags
            </h3>
            <div class="flex flex-wrap gap-2">
              {tags.map(tag => (
                <Badge variant="secondary">
                  <a href={`/blog/tag/${tag}`}>#{tag}</a>
                </Badge>
              ))}
            </div>
          </div>

          <!-- Share Buttons -->
          <div>
            <ShareButtons
              title={title}
              url={Astro.url.toString()}
              description={description}
              showLabel={true}
              size="md"
            />
          </div>
        </footer>
      </article>

      <!-- Sidebar -->
      <aside class="space-y-8">
        <!-- Table of Contents (sticky) -->
        {headings.length > 0 && (
          <div class="lg:sticky lg:top-8">
            <TableOfContents headings={headings} />
          </div>
        )}
      </aside>
    </div>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="mt-16 pt-16 border-t border-border-light dark:border-border-dark">
        <h2 class="text-2xl font-bold mb-8 text-text-primary-light dark:text-text-primary-dark">
          You Might Also Like
        </h2>
        <div class="grid md:grid-cols-3 gap-6">
          {relatedPosts.map(async (relatedPost) => {
            const relatedReadingTime = calculateReadingTime(relatedPost.body);
            return (
              <Card>
                <div class="flex items-center gap-2 text-sm text-text-secondary-light dark:text-text-secondary-dark mb-3">
                  <span class="px-2 py-1 bg-eucalyptus-100 dark:bg-eucalyptus-900 text-eucalyptus-700 dark:text-eucalyptus-300 rounded text-xs">
                    {relatedPost.data.category}
                  </span>
                  <time datetime={relatedPost.data.pubDate.toISOString()}>
                    {relatedPost.data.pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                  </time>
                  <span class="text-text-tertiary-light dark:text-text-tertiary-dark">â€¢</span>
                  <span class="text-text-tertiary-light dark:text-text-tertiary-dark">
                    {relatedReadingTime.text}
                  </span>
                </div>
                <h3 class="text-lg font-bold mb-2 text-text-primary-light dark:text-text-primary-dark">
                  <a href={`/blog/${relatedPost.slug}`} class="hover:text-eucalyptus-600 dark:hover:text-eucalyptus-400 transition-colors">
                    {relatedPost.data.title}
                  </a>
                </h3>
                <p class="text-text-secondary-light dark:text-text-secondary-dark text-sm line-clamp-2">
                  {relatedPost.data.description}
                </p>
              </Card>
            );
          })}
        </div>
      </section>
    )}

    <!-- Newsletter Signup -->
    <Newsletter variant="inline" showTopicSelection={true} />

    <!-- Comments Section -->
    <Comments />
  </Container>
</BaseLayout>

<style is:global>
  /* Custom prose styling for code blocks with Shiki */
  .prose pre {
    @apply border rounded-lg p-4 overflow-x-auto;
    background-color: #f8f9fa !important;
    border-color: #e9ecef !important;
  }

  .dark .prose pre {
    background-color: #1e2126 !important;
    border-color: #3a3f47 !important;
  }

  .prose code {
    @apply text-eucalyptus-700 dark:text-eucalyptus-300 bg-eucalyptus-50 dark:bg-eucalyptus-900 px-1 py-0.5 rounded text-sm;
  }

  .prose pre code {
    @apply bg-transparent p-0 text-base;
    color: inherit !important;
  }

  /* Shiki syntax highlighting - ensure good contrast */
  .prose pre,
  .prose pre code,
  .prose pre code span {
    color: #24292e !important;
  }

  .dark .prose pre,
  .dark .prose pre code,
  .dark .prose pre code span {
    color: #e6edf3 !important;
  }

  /* Smooth scroll for TOC links */
  html {
    scroll-behavior: smooth;
  }
</style>
