---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Container from '@/components/ui/Container.astro';
import PostList from '@/components/blog/PostList.astro';

// Get all published blog posts, sorted by date (newest first)
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Pagination settings
const postsPerPage = 9;
const currentPage = 1;
const totalPages = Math.ceil(sortedPosts.length / postsPerPage);
const paginatedPosts = sortedPosts.slice(0, postsPerPage);

// Get unique categories for filter
const categories = [...new Set(allPosts.map(post => post.data.category))];

// Get featured posts
const featuredPosts = sortedPosts.filter(post => post.data.featured).slice(0, 3);

const pageTitle = 'Blog - Mihai Adrian Mateescu';
const pageDescription = 'Articles about AI/ML, finance, FinTech, Rust, Julia, and the intersection of technology and accounting.';
---

<BaseLayout title={pageTitle} description={pageDescription} lang="de">
  <Container paddingY="lg">
    <main>
      <!-- Page Header -->
      <div class="mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-text-primary-light dark:text-text-primary-dark mb-4">
          Blog
        </h1>
        <p class="text-xl text-text-secondary-light dark:text-text-secondary-dark max-w-3xl">
          Exploring the intersection of finance, AI/ML, and software engineering.
          {sortedPosts.length} articles and counting.
        </p>
      </div>

      <!-- Featured Posts -->
      {featuredPosts.length > 0 && (
        <section class="mb-16">
          <h2 class="text-2xl font-bold mb-6 text-text-primary-light dark:text-text-primary-dark">
            Featured Posts
          </h2>
          <div class="grid md:grid-cols-3 gap-8">
            {featuredPosts.map(post => (
              <article class="border border-border-light dark:border-border-dark rounded-lg p-6 hover:border-eucalyptus-500 transition-colors bg-surface-light dark:bg-surface-dark">
                <div class="flex items-center gap-2 text-sm text-text-secondary-light dark:text-text-secondary-dark mb-3">
                  <span class="px-2 py-1 bg-eucalyptus-100 dark:bg-eucalyptus-900 text-eucalyptus-700 dark:text-eucalyptus-300 rounded">
                    {post.data.category}
                  </span>
                  <time datetime={post.data.pubDate.toISOString()}>
                    {post.data.pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                  </time>
                </div>
                <h3 class="text-xl font-bold mb-2 text-text-primary-light dark:text-text-primary-dark">
                  <a href={`/blog/${post.slug}`} class="hover:text-eucalyptus-600 dark:hover:text-eucalyptus-400">
                    {post.data.title}
                  </a>
                </h3>
                <p class="text-text-secondary-light dark:text-text-secondary-dark mb-4">
                  {post.data.description}
                </p>
                <div class="flex flex-wrap gap-2">
                  {post.data.tags.slice(0, 3).map(tag => (
                    <span class="text-xs px-2 py-1 bg-surface-light dark:bg-surface-dark text-text-secondary-light dark:text-text-secondary-dark rounded border border-border-light dark:border-border-dark">
                      #{tag}
                    </span>
                  ))}
                </div>
              </article>
            ))}
          </div>
        </section>
      )}

      <!-- Category Filter -->
      <div class="mb-8 flex flex-wrap gap-2">
        <a
          href="/blog"
          class="px-4 py-2 bg-eucalyptus-600 text-white rounded-md font-semibold"
        >
          All Posts
        </a>
        {categories.map(category => (
          <a
            href={`/blog/category/${category}`}
            class="px-4 py-2 bg-surface-light dark:bg-surface-dark text-text-primary-light dark:text-text-primary-dark rounded-md hover:bg-eucalyptus-100 dark:hover:bg-eucalyptus-900 transition-colors border border-border-light dark:border-border-dark"
          >
            {category}
          </a>
        ))}
      </div>

      <!-- All Posts -->
      <PostList posts={paginatedPosts} />

      <!-- Pagination -->
      {totalPages > 1 && (
        <div class="mt-12 flex justify-center gap-2">
          {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
            <a
              href={page === 1 ? '/blog' : `/blog/page/${page}`}
              class:list={[
                'px-4 py-2 rounded-md border',
                page === currentPage
                  ? 'bg-eucalyptus-600 text-white border-eucalyptus-600'
                  : 'bg-surface-light dark:bg-surface-dark text-text-primary-light dark:text-text-primary-dark border-border-light dark:border-border-dark hover:bg-eucalyptus-100 dark:hover:bg-eucalyptus-900'
              ]}
            >
              {page}
            </a>
          ))}
        </div>
      )}

      <!-- RSS Subscribe -->
      <div class="mt-16 p-6 bg-eucalyptus-50 dark:bg-eucalyptus-900 rounded-lg">
        <h2 class="text-xl font-bold mb-2 text-text-primary-light dark:text-text-primary-dark">
          Subscribe via RSS
        </h2>
        <p class="text-text-secondary-light dark:text-text-secondary-dark mb-4">
          Get notified of new posts in your RSS reader
        </p>
        <a
          href="/rss.xml"
          class="inline-flex items-center gap-2 px-4 py-2 bg-eucalyptus-600 text-white rounded-md font-semibold hover:bg-eucalyptus-700 transition-colors"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5 3a1 1 0 000 2c5.523 0 10 4.477 10 10a1 1 0 102 0C17 8.373 11.627 3 5 3z" />
            <path d="M4 9a1 1 0 011-1 7 7 0 017 7 1 1 0 11-2 0 5 5 0 00-5-5 1 1 0 01-1-1zM3 15a2 2 0 114 0 2 2 0 01-4 0z" />
          </svg>
          Subscribe to RSS Feed
        </a>
      </div>
    </main>
  </Container>
</BaseLayout>
